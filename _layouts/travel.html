<html>
{% include head.html %}
<body style="background-color: #2a2a2a;">

{%-include back_link.html-%}

<style>
    /* Override main.css constraints for full-width map */
    body {
        max-width: none;
        padding: 0;
        margin: 0;
    }
    #map {
        position: absolute;
        top: 10%;
        bottom: 10px;
        left: 0;
        width: 100%;
    }
    #map-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #8F8A89;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    .maplibregl-popup-content {
        background: #161616;
        color: #f2f2f2;
        border-radius: 8px;
        padding: 12px 14px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
    }
    .maplibregl-popup-content h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
    }
    .maplibregl-popup-close-button {
        color: #f2f2f2;
        font-size: 18px;
    }
    .maplibregl-popup-close-button:hover {
        color: #ffffff;
        background: transparent;
    }
    .maplibregl-popup-tip {
        border-top-color: #161616;
        border-bottom-color: #161616;
    }
</style>

<div id="map">
    <div id="map-loading">Loading map...</div>
</div>

<script>
    // Lazy-load MapLibre only when the page is visible
    function initMap() {
        // Location data from Jekyll
        var locations = {{ site.data.locations | jsonify }};
        var loading = document.getElementById('map-loading');

        var map = new maplibregl.Map({
            container: 'map',
            style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
            center: [10, 50],
            zoom: 1
        });

        map.on('load', function() {
            if (loading) {
                loading.style.display = 'none';
            }

            locations.forEach(function(location) {
                new maplibregl.Marker({color: '#8F8A89'})
                    .setLngLat([location.lng, location.lat])
                    .setPopup(new maplibregl.Popup({ offset: 25 })
                        .setHTML('<h3>' + location.name + '</h3>'))
                    .addTo(map);
            });
        });

        map.on('error', function() {
            if (loading) {
                loading.textContent = 'Map failed to load.';
            }
        });
    }

    // Lazy-load MapLibre CSS and JS
    function loadMapLibrary() {
        // Load CSS
        var css = document.createElement('link');
        css.rel = 'stylesheet';
        css.href = 'https://unpkg.com/maplibre-gl@3.5.1/dist/maplibre-gl.css';
        document.head.appendChild(css);

        // Load JS
        var script = document.createElement('script');
        script.src = 'https://unpkg.com/maplibre-gl@3.5.1/dist/maplibre-gl.js';
        script.onload = initMap;
        script.onerror = function() {
            var loading = document.getElementById('map-loading');
            if (loading) {
                loading.textContent = 'Map failed to load.';
            }
        };
        document.head.appendChild(script);
    }

    // Load map when page becomes visible or on DOMContentLoaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadMapLibrary);
    } else {
        loadMapLibrary();
    }
</script>

{{ content }}

</body>
</html>
