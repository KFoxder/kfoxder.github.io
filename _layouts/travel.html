<html>
{% include head.html %}
<body style="background-color: #2a2a2a;">

{%-include back_link.html-%}

<style>
    #map {
        position: absolute;
        top: 10%;
        bottom: 10px;
        width: 100%;
    }
    #map-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #8F8A89;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
</style>

<div id="map">
    <div id="map-loading">Loading map...</div>
</div>

<script>
    // Lazy-load Mapbox only when the page is visible
    function initMap() {
        // Location data from Jekyll
        var locations = {{ site.data.locations | jsonify }};

        mapboxgl.accessToken = 'pk.eyJ1Ijoia2ZveDIwMTAiLCJhIjoiY2o4b3Zxa2dwMDhuMjJxcnpzbWh3aDFoZSJ9.F_bujUHk3bxIDCJfBOGmTg';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v11',
            center: [10, 50],
            zoom: 1
        });

        map.on('load', function() {
            document.getElementById('map-loading').style.display = 'none';

            locations.forEach(function(location) {
                new mapboxgl.Marker({color: '#8F8A89'})
                    .setLngLat([location.lng, location.lat])
                    .setPopup(new mapboxgl.Popup({ offset: 25 })
                        .setHTML('<h3>' + location.name + '</h3>'))
                    .addTo(map);
            });
        });
    }

    // Lazy-load Mapbox CSS and JS
    function loadMapbox() {
        // Load CSS
        var css = document.createElement('link');
        css.rel = 'stylesheet';
        css.href = 'https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css';
        document.head.appendChild(css);

        // Load JS
        var script = document.createElement('script');
        script.src = 'https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js';
        script.onload = initMap;
        document.head.appendChild(script);
    }

    // Load map when page becomes visible or on DOMContentLoaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadMapbox);
    } else {
        loadMapbox();
    }
</script>

{{ content }}

</body>
</html>
